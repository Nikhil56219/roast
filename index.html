<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goofy ahh roast station</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        /* Global Style: Black Background, White Text */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111111; /* Main Background: Black */
            color: #FFFFFF; /* Default Text: White */
        }
        /* Custom colors based on user request */
        .theme-yellow { background-color: #FFD500; } /* Highlight Color */
        .theme-black-bg { background-color: #111111; }
        .theme-white-bg { background-color: #FFFFFF; }
        .theme-black-text { color: #000000; }
        .theme-white-text { color: #FFFFFF; }
        .border-white-thin { border: 1px solid #FFFFFF; } /* White Accent/Border */
        
        /* New Global Button Style for "I'm gay" (Used for navigation/actions unless overridden) */
        .gay-button {
             /* Black BG, White Text, White Border (Secondary style) */
             background-color: #111111 !important;
             color: #FFFFFF !important;
             border: 2px solid #FFFFFF !important;
             font-weight: 800; /* Extra bold */
             transition: all 0.2s;
        }
        .gay-button:hover {
             background-color: #FFFFFF !important;
             color: #000000 !important;
             border-color: #FFD500 !important;
        }

        /* Specific Sand Roast Button Style with Glow/Pulse Hover */
        .sand-roast-button {
            background-color: #111111 !important;
            color: #FFD500 !important;
            border: 2px solid #FFD500 !important;
            font-weight: 900;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(255, 213, 0, 0.5); /* Initial soft yellow shadow */
        }
        .sand-roast-button:hover {
            background-color: #FFD500 !important;
            color: #111111 !important;
            box-shadow: 0 0 15px #FFD500, 0 0 25px #FFD500; /* Intense glow */
            transform: scale(1.02);
        }
        
        /* Specific login button style (Yellow BG, Black Text, Black Border) */
        .login-button {
            background-color: #FFD500 !important;
            color: #000000 !important;
            border: 2px solid #000000 !important;
            font-weight: 800;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 #000000; /* Initial shadow */
        }
        .login-button:hover {
            background-color: #FFFFFF !important;
            color: #000000 !important;
            box-shadow: 6px 6px 0 #111111; /* Shifted shadow effect */
        }
        
        /* New style for the "Roast them back" button to make it pop */
        .roast-back-button {
            background-color: #FFD500 !important;
            color: #000000 !important;
            border: 2px solid #000000 !important;
            font-weight: 800;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 #000000;
        }
        .roast-back-button:hover {
            background-color: #FFFFFF !important;
            box-shadow: 6px 6px 0 #111111;
        }

        /* Large, Edgy Title Style */
        .roast-title {
            font-size: 3rem; /* Adjusted for better mobile fit */
            line-height: 1;
            text-shadow: 4px 4px #000000; /* Black shadow for cartoonish depth */
        }
        @media (min-width: 768px) {
            .roast-title {
                font-size: 4.5rem;
            }
        }
        
        /* Modal Overlay Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Dark background */
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Loading Animation Spinner */
        .roast-sending-spinner {
            border-top-color: #FFD500;
            border-right-color: transparent;
            border-bottom-color: #FFD500;
            border-left-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center items-start">

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, updateDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // --- GLOBAL CONSTANTS ---
        // Base Logo URL (Default Logo)
        const BASE_IMAGE_URL = "https://i.ibb.co/27Rt9p5d/Whats-App-Image-2025-10-03-at-19-52-49-ce9f69b5.jpg";
        
        // Custom URLs for friends - YOU WILL REPLACE THESE PLACEHOLDERS
        const CUSTOM_LOGOS = {
            // FIX: Use uppercase keys for consistent lookup in getDynamicLogoUrl
            'NIKHIL': "https://i.ibb.co/mCQcfdmd/Whats-App-Image-2025-10-05-at-12-43-08-8bc20714.jpg",
            'SHANMUKH': "https://i.ibb.co/7xPBkktS/Whats-App-Image-2025-10-05-at-12-27-16-fc6f2249.jpg",
            // FIX: Added missing commas
            'SAHITI': "https://i.ibb.co/ynftQ02D/Whats-App-Image-2025-10-05-at-12-25-00-25ad8b92.jpg",
            'USMANI': "https://i.ibb.co/pj32wsZC/Whats-App-Image-2025-10-05-at-12-28-41-e6f3e837.jpg",
        };

        const appId = 'roast-station-app'; // Hardcoded unique identifier for your app's data path
        
        // ***************************************************************
        // !!! YOUR CONFIGURATION !!!
        // ***************************************************************
        const firebaseConfig = JSON.parse(
             '{"apiKey": "AIzaSyBiOzckIKs0VHntmesg51hUAgTuLXNXDyw", "authDomain": "ssun-3f880.firebaseapp.com", "projectId": "ssun-3f880", "storageBucket": "ssun-3f880.firebasestorage.app", "messagingSenderId": "858195643805", "appId": "1:858195643805:web:787f74900711c2babef374", "measurementId": "G-4R9Y40MET8"}'
        );
        // ***************************************************************
        
        const initialAuthToken = null; // No custom token needed for public deployment, using anonymous sign-in

        // FIX: Moved fetchedRoasts definition to the absolute top of the script
        let fetchedRoasts = []; 

        let app, db, auth, currentUserId = null, currentUserName = null;
        
        // --- PERSISTENCE FLAG: Tracks if the user failed the name entry once ---
        let hasFailedUselessPage = false; 
        
        // --- SESSION DATA FOR REPLIES ---
        let activeRoastData = null; // Used by reply_roast view
        let replyTargetSession = null; // NEW: Used to store target when redirecting to Home Base

        
        // Page Names: 'spawn_point' (Rules), 'useless_page' (Name Input), 'useless_result' (Name Roast), 'home_base' (Submit/Login), 'the_hit_list' (Inbox), 'reply_roast' (New Page)
        let currentView = 'spawn_point'; 
        
        // UPDATED FRIEND NAMES (Original names used for display/login/target)
        // CHANGED ORDER TO: Shanmukh, Sahiti, Nikhil, Usmani
        const FRIENDS = ['Shanmukh', 'Sahiti', 'Nikhil', 'Usmani'];
        
        // List of all possible random roasts for the Useless Page (If friend name entered)
        const FRIEND_ROAST_LINES = [
            "How do I even pronounce this disaster?",
            "Who hurt you enough to pick this name?",
            "Did your parents lose a bet?",
            "Are you sure this isn’t a typo?",
            "This sounds like a failed WiFi password.",
            "And people call you by this voluntarily?",
            "You really looked at that name and said ‘yeah, this works.’",
            "Sounds like your parents picked letters out of a Scrabble bag.",
            "I’ve seen better names on spam emails.",
            "Your name sounds like an expired coupon code."
        ];
        
        // List of failure roasts (If non-friend name entered)
        const FAILURE_ROAST_LINES = [
            "Wow… you really failed at the easiest part",
            "Not even this small thing",
            "Can’t handle one little question?",
            "Seriously… you can’t type your name?",
            "Even this is too much?",
            "Wow… too hard for you",
            "you can’t answer a simple question…",
            "Can’t type your own name, huh?",
            "Not even this basic task?"
        ];


        // --- Utility Functions ---
        // NEW FUNCTION: Dynamically choose logo based on current user or default
        const getDynamicLogoUrl = (forUserName = currentUserName) => {
             // Check if a specific user name is provided (like from the Useless Page result)
             const checkName = forUserName ? forUserName.toUpperCase() : '';
             
             // Check if user is logged in OR a specific name was passed AND has a custom logo defined
             if (checkName && CUSTOM_LOGOS[checkName]) {
                 return CUSTOM_LOGOS[checkName];
             }
             // Otherwise, return the main app logo
             return BASE_IMAGE_URL;
        };


        const getRoastCollectionRef = () => {
            if (!db) return null;
            // Public collection path: /artifacts/{appId}/public/data/roasts
            return collection(db, `artifacts/${appId}/public/data/roasts`);
        };
        
        const getTaskCollectionRef = () => {
             if (!db) return null;
             // Public collection path for reveal tasks (RETAINED for database structure, but unused in non-anonymous mode)
             return collection(db, `artifacts/${appId}/public/data/reveal_tasks`);
        };


        const getFriendProfileRef = (uid) => {
             if (!db) return null;
             // Private user profile path: /artifacts/{appId}/users/{userId}/profiles/current
             // Note: Using public path for simplicity in a deployed environment where all users are anonymous/ephemeral
             return doc(db, `artifacts/${appId}/users/${uid}/profiles/current`);
        }
        
        const generateTaskCode = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        };

        const showMessage = (message, isError = false) => {
            const container = document.getElementById('message-container');
            // Yellow background, Black text for success/info. Red for error.
            container.innerHTML = `<div class="p-3 mt-4 rounded-lg text-sm font-semibold shadow-md ${isError ? 'bg-red-500 text-white' : 'theme-yellow theme-black-text'}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        };

        // --- Authentication and Initialization ---
        const initializeFirebase = async () => {
            if (firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    await new Promise(resolve => {
                        const unsubscribe = onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                currentUserId = user.uid;
                                console.log('Authenticated user:', currentUserId);
                                await loadUserName();
                                unsubscribe();
                                resolve();
                            } else {
                                console.log('No user signed in. Attempting sign-in anonymously...');
                                try {
                                    // Attempt sign in anonymously
                                    await signInAnonymously(auth);
                                } catch (error) {
                                    console.error("Anonymous Sign-in Failed:", error);
                                    if (error.code === 'auth/configuration-not-found') {
                                        showMessage("Auth Error: Authentication is not enabled. Please enable **Anonymous** sign-in in your Firebase console (Authentication > Sign-in method).", true);
                                    } else {
                                        showMessage(`Auth Error: ${error.message}`, true);
                                    }
                                } finally {
                                    unsubscribe();
                                    resolve();
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    showMessage(`Error initializing app: ${error.message}`, true);
                }
            } else {
                showMessage("Firebase configuration is missing. Please ensure you have replaced the placeholder config with your actual Firebase project details.", true);
            }
        };

        const loadUserName = async () => {
             if (!db || !currentUserId) return;
             try {
                 const profileDoc = await getDoc(getFriendProfileRef(currentUserId));
                 if (profileDoc.exists()) {
                     currentUserName = profileDoc.data().name;
                     console.log('User Name loaded:', currentUserName);
                 }
                 renderApp();
             } catch (error) {
                 console.error("Error loading user name:", error);
                 showMessage("Could not load your profile. Try reloading.", true);
             }
         };

        const setUserName = async (name) => {
            if (!db || !currentUserId) return;
            try {
                // Save name to private user profile and navigate to inbox
                await setDoc(getFriendProfileRef(currentUserId), { name: name });
                currentUserName = name;
                console.log('User Name set:', currentUserName);
                window.changeView('the_hit_list'); 
            } catch (error) {
                console.error("Error setting user name:", error);
                showMessage("Could not save your name. Try again.", true);
            }
        };
        
        // Function to clear user name and return to the submission/login screen (Home Base)
        window.logOut = () => {
             currentUserName = null;
             currentView = 'home_base'; // Go back to the submit/login screen
             renderApp();
        };

        // --- Core Application Logic (Roast Submission/Inbox) ---

        const showRoastSentModal = (targetName) => {
            const modalHTML = `
                <div class="modal-overlay" onclick="document.getElementById('modal-root').innerHTML = ''">
                    <div class="theme-yellow p-8 rounded-xl shadow-2xl border-4 border-black text-center max-w-sm" onclick="event.stopPropagation()">
                        
                        <!-- Logo Placeholder in Modal -->
                        <img src="${getDynamicLogoUrl()}" 
                             alt="Modal Logo" 
                             class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                        
                        <h2 class="text-5xl font-extrabold theme-black-text mb-6">ROAST SENT!</h2>
                        
                        <!-- Button is I'm gay (gay-button style) -->
                        <button onclick="document.getElementById('modal-root').innerHTML = ''" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                            I'm gay
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-root').innerHTML = modalHTML;
        };


        const submitRoast = async (targetName, roastText, senderName) => {
            // Find the active submit button based on ID for visual feedback
            const submitButton = document.querySelector('.sand-roast-button') || document.querySelector('#reply-roast-button');
            
            // Determine if this is a reply submission based on the session data
            const isReply = currentView === 'reply_roast';

            if (!senderName || !targetName || !roastText) {
                showMessage("Please select a sender, target, and write a roast.", true);
                return;
            }

            if (senderName === targetName) {
                showMessage("You can't roast yourself! Pick a friend.", true);
                return;
            }

            // Show sending animation
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="roast-sending-spinner w-6 h-6 border-4 rounded-full mx-auto"></div>`;
            }

            try {
                // Simulate delay for animation visibility (1.5 seconds)
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                await addDoc(getRoastCollectionRef(), {
                    target: targetName,
                    senderName: senderName, // Stored for visibility
                    roastText: roastText,
                    isRead: false, 
                    isRevealed: true, // NON-ANONYMOUS MODE: Always true
                    createdAt: new Date()
                });
                
                // --- Post Submission Flow ---
                if (isReply) {
                    // If it was a reply, clear session and go back to the Hit List
                    activeRoastData = null; 
                    window.changeView('the_hit_list');
                    showMessage("Retaliation sand successfully!", false);
                } else {
                    // This is the main submission flow
                    showRoastSentModal(targetName); 
                    // Clear inputs for main form only
                    document.getElementById('roast-text').value = ''; 
                    const senderSelectElement = document.getElementById('roast-sender-select');
                    if (senderSelectElement) senderSelectElement.value = ''; 
                    document.getElementById('roast-target').value = ''; 
                }
            } catch (error) {
                console.error("Error submitting roast:", error);
                showMessage("Failed to submit roast. Check console for details.", true);
            } finally {
                 if (submitButton) {
                    // Reset button regardless of success/failure
                    submitButton.disabled = false;
                    submitButton.textContent = isReply ? "Sand Reply Roast" : "Sand roast";
                }
            }
        };

        // Main form submission wrapper
        const handleMainRoastSubmission = () => {
            const targetName = document.getElementById('roast-target').value;
            const roastText = document.getElementById('roast-text').value.trim();
            const senderSelectElement = document.getElementById('roast-sender-select');
            const determinedSender = currentUserName || (senderSelectElement ? senderSelectElement.value : null);
            
            submitRoast(targetName, roastText, determinedSender);
        };
        
        // Function to fetch all roasts and display them in a list format
        const getRoastsForInbox = async () => {
             if (!db || !currentUserName) return;
             
             // The inbox list will replace the button
             const inboxContainer = document.getElementById('roast-guess-box'); 
             inboxContainer.innerHTML = `<p class="text-xl font-semibold theme-black-text">Fetching roasts...</p>`;

             try {
                 // Query for ALL roasts targeted at the current user
                 const q = query(getRoastCollectionRef(), where("target", "==", currentUserName));
                 const snapshot = await getDocs(q);

                 if (snapshot.empty) {
                     inboxContainer.innerHTML = `<p class="text-xl font-semibold theme-black-text">🎉 Inbox empty. Looks like you're safe (for now)!</p>`;
                     return;
                 }
                 
                 // Collect and sort roasts by creation date (newest first) in memory
                 fetchedRoasts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 fetchedRoasts.sort((a, b) => b.createdAt.toDate().getTime() - a.createdAt.toDate().getTime()); // Sort by newest first

                 const messageListHTML = fetchedRoasts.map((roast, index) => {
                     // Get formatted time and date
                     const date = roast.createdAt.toDate();
                     const dateStr = date.toLocaleDateString();
                     const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                     const dateTimeStr = `${dateStr} ${timeStr}`;

                     // ANONYMOUS MODE FOR DISPLAY: Use *** for the title
                     const titleText = '***'; 

                     return `
                     <!-- Message Card: Clicking reveals the detail modal -->
                     <div class="p-4 mb-3 rounded-lg border-2 border-black cursor-pointer ${roast.isRead ? 'theme-yellow opacity-75' : 'theme-white-bg'}" 
                          onclick="showRoastDetailModal(${index})">
                         <div class="flex justify-between items-start mb-2">
                             <!-- Sender Name (NOW VISIBLE) -->
                             <span class="font-extrabold text-lg theme-black-text">${titleText}</span>
                             <!-- Date/Time Display -->
                             <span class="text-xs theme-black-text">${dateTimeStr}</span>
                         </div>
                         <!-- Roast Text Preview -->
                         <p class="font-medium text-base theme-black-text">${roast.roastText.substring(0, 50)}${roast.roastText.length > 50 ? '...' : ''}</p>
                         <p class="text-right text-xs mt-2 theme-black-text italic">${roast.isRead ? '— Read' : '— New'}</p>
                     </div>
                 `;
                 }).join('');

                 inboxContainer.innerHTML = `<div class="max-h-96 overflow-y-scroll p-2 theme-black-bg">${messageListHTML}</div>`;

             } catch (error) {
                 console.error("Error fetching roast inbox:", error);
                 showMessage("Failed to fetch roast inbox.", true);
             }
         };
         
        // Function to mark a roast as read (called when the detail modal is opened)
         window.markRoastAsRead = async (roastId) => {
             try {
                 const roastRef = doc(getRoastCollectionRef(), roastId);
                 // Only update if it's currently unread
                 const docSnap = await getDoc(roastRef);
                 if (docSnap.exists() && !docSnap.data().isRead) {
                    await updateDoc(roastRef, { isRead: true });
                 }
             } catch (error) {
                 console.error("Failed to mark roast as read:", error);
             }
         };

        // New function to redirect to the reply page and set session data
        window.startAnonymousReply = (roast) => {
            // FIX: Use URL hash instead of history.replaceState to prevent SecurityError in iframes/local files.
            
            const senderNameEncoded = encodeURIComponent(roast.senderName);
            
            // Navigate to Home Base and pass the target via the URL hash
            window.location.hash = `#view=home_base&replyTarget=${senderNameEncoded}`;
        };

        // Renders the reply form inside the modal (This is now redundant but kept for clarity if we needed the modal view)
        window.renderReplyRoastForm = (roast) => {
            // We use the new dedicated page now, so this is just here to prevent errors if older code calls it
            window.startAnonymousReply(roast);
        };

        // Wrapper function to handle reply submission from the dedicated page
        const handleReplyRoastSubmission = () => {
            if (!activeRoastData) {
                showMessage("Error: Cannot find target for revenge roast.", true);
                return;
            }
            const roastText = document.getElementById('reply-roast-text').value.trim();
            // In a reply: target is the original sender, sender is the current user (from activeRoastData)
            submitRoast(activeRoastData.target, roastText, activeRoastData.replyingAs);
        };
         
         // Function to show the roast detail and the task/reveal status
         window.showRoastDetailModal = async (index) => {
             // Access the global fetchedRoasts array
             const roast = fetchedRoasts[index];
             if (!roast) return;
             
             // Mark as read and refresh the list in the background
             await window.markRoastAsRead(roast.id);
             getRoastsForInbox();
             
             const modalRoot = document.getElementById('modal-root');
             
             // NON-ANONYMOUS MODE: No identity reveal logic needed here.

             modalRoot.innerHTML = `
                 <div class="modal-overlay" onclick="closeModal()">
                     <!-- MODAL CONTAINER: Changed to BLACK background -->
                     <div id="roast-detail-container" class="theme-black-bg p-8 rounded-xl shadow-2xl border-4 border-white text-center max-w-lg theme-white-text" onclick="event.stopPropagation()">
                         <h2 class="text-3xl font-extrabold mb-4">YOU'VE BEEN ROASTED!</h2>
                         
                         <div id="roast-detail-content">
                             <!-- Roast Text in Yellow Box -->
                             <p class="text-xl font-medium mb-4 p-4 theme-yellow rounded-lg italic theme-black-text text-left">${roast.roastText}</p>
                             
                             <!-- Removed SENT BY: Identity is already known from the inbox preview -->

                             <!-- Buttons for Roast Back and Close -->
                             <div class="grid grid-cols-2 gap-4 mb-4">
                                 <!-- FIX: Pass the roast object to ensure we get the senderName -->
                                 <button onclick="window.startAnonymousReply(fetchedRoasts[${index}])" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 roast-back-button">
                                     Roast them back
                                 </button>
                                 <button onclick="window.closeModal()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                                     Close
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
         };
         
         // Helper function to get the current task status for a roast (REMOVED: Task logic is obsolete)
         const getTaskStatus = async (roastId) => {
             // Function is kept as a stub to avoid errors in simplified code, but always returns null
             return null;
         };
         
         // 1. ROASTED USER: Requests the task (REMOVED: Task logic is obsolete)
         window.requestRoasterReveal = (roastId, targetName, senderName) => {
             showMessage("Anonymous reveal system is deactivated. Sender identity is always visible.", false);
         };
         
         // 2. ROASTED USER: Submits the task code (REMOVED: Task logic is obsolete)
         window.submitTaskCode = (roastId) => {
             showMessage("Task submission is obsolete.", true);
         };
         
         // 3. ROASTER: Generates the task code (REMOVED: Task logic is obsolete)
         window.generateTask = (taskDocId, roastId, senderName) => {
             showMessage("Task generation is obsolete.", true);
         };
         
         // Function to fetch tasks assigned TO the current user (REMOVED: Task logic is obsolete)
         window.getRoasterTasks = async () => {
             const taskContainer = document.getElementById('roaster-task-list');
             if (taskContainer) {
                 taskContainer.innerHTML = `<p class="theme-black-text">Task system is currently disabled (Non-Anonymous Mode).</p>`;
             }
         };
         
         // Navigation functions are kept
         window.goToRoasterTasks = () => {
             showMessage("Roaster Admin is disabled because anonymity is turned off.", true);
         };
         
         window.goToInbox = () => {
             window.changeView('the_hit_list');
         };


        // --- Page Navigation and Rendering Setup ---
        
        // Function to move from rules screen (Spawn Point) to the useless name page
        window.acceptRules = () => {
            currentView = 'useless_page'; 
            renderApp();
        };
        
        // Function to process the name input from the useless page
        window.processUselessName = () => {
            const inputElement = document.getElementById('useless-name-input');
            const enteredName = inputElement.value.trim();

            if (!enteredName) {
                showMessage("Seriously? Enter your pathetic name.", true);
                return;
            }
            
            // If the input is already hijacked, the user intended to proceed (since they can't type)
            if (inputElement.readOnly) {
                window.changeView('home_base');
                return;
            }

            // --- Case-Insensitive Check ---
            // FIX: Ensure comparison is case-insensitive
            const isFriend = FRIENDS.some(f => f.toLowerCase() === enteredName.toLowerCase());

            let roast;
            if (isFriend) {
                // If friend, choose a random FRIEND roast
                roast = FRIEND_ROAST_LINES[Math.floor(Math.random() * FRIEND_ROAST_LINES.length)];
                hasFailedUselessPage = false; // Reset failure flag on success
            } else {
                // If non-friend, choose a random FAILURE roast
                roast = FAILURE_ROAST_LINES[Math.floor(Math.random() * FAILURE_ROAST_LINES.length)];
                hasFailedUselessPage = true; // Set the flag to true on the first failure
            }

            window.changeView('useless_result', { name: enteredName, roast: roast, isFriend: isFriend }); // Pass isFriend flag
        };
        
        // Custom changeView function to handle data passing
        window.changeView = (newView, data = null) => {
             currentView = newView;
             
             // If we're changing to a clean view, clear the URL hash (like logging out)
             if (currentView !== 'home_base') {
                 window.location.hash = ''; // Clear hash for non-home-base views
             }

             renderApp(data);
        };
        
        // --- INPUT HIJACKING LOGIC ---
        // Function called when the user focuses/types in the input field AFTER first failure
        window.hijackInput = (inputElement) => {
            const sarcasticMessage = "you really thought , i would give your lazy ass a second chance , click that button and gtfo";
            
            // Only hijack if the flag is set AND the field isn't already readOnly
            if (hasFailedUselessPage && !inputElement.readOnly) {
                inputElement.value = sarcasticMessage;
                // Lock the field after the message is displayed
                inputElement.readOnly = true; 
            }
        };

        // --- URL Parameter Utility ---
        const getUrlParameter = (name) => {
            // Get parameter from URL hash (e.g., #view=home_base&replyTarget=Nikhil)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get(name);
        };


        // Expose functions to the window so they can be called from inline HTML
        window.submitRoast = handleMainRoastSubmission;
        window.handleReplyRoastSubmission = handleReplyRoastSubmission;
        window.renderReplyRoastForm = renderReplyRoastForm;
        window.setUserName = setUserName;
        window.logOut = logOut; 
        window.getRoastsForInbox = getRoastsForInbox; 
        window.markRoastAsRead = markRoastAsRead; 
        window.showRoastDetailModal = showRoastDetailModal; 
        window.requestRoasterReveal = requestRoasterReveal; // Corrected exposure
        window.closeModal = () => { document.getElementById('modal-root').innerHTML = ''; getRoastsForInbox(); }; // Enhanced closeModal
        window.goToSpawnPoint = () => { currentUserName = null; currentView = 'spawn_point'; renderApp(); };
        window.goToRoasterTasks = goToRoasterTasks;
        window.goToInbox = goToInbox;
        window.generateTask = generateTask;
        window.submitTaskCode = submitTaskCode;
        window.getRoasterTasks = getRoasterTasks;
        window.startAnonymousReply = startAnonymousReply; // FIX: Ensure this is correctly exposed


        // --- View Rendering ---

        const renderApp = (data = null) => {
            const appContainer = document.getElementById('app-container');
            
            // Check URL hash for reply parameters BEFORE rendering the view
            const urlTarget = getUrlParameter('replyTarget');
            const urlView = getUrlParameter('view');
            
            // Priority check: If URL hash indicates home_base, override currentView
            if (urlView === 'home_base' && urlTarget) {
                currentView = 'home_base';
                replyTargetSession = decodeURIComponent(urlTarget); // Set session variable from URL
                
                // Clear the URL hash immediately after reading it to prevent loop/data confusion on refresh
                window.location.hash = ''; 
            } else {
                 replyTargetSession = null; // Clear session if not coming from a reply link
            }
            
            
            if (currentView === 'spawn_point') {
                renderRulesScreen(appContainer);
            } else if (currentView === 'useless_page') {
                renderUselessPage(appContainer);
            } else if (currentView === 'useless_result') {
                renderUselessResult(appContainer, data); // Pass data (name)
            } else if (!currentUserName) {
                // If not logged in and past rules, show submit/login screen (Home Base)
                renderWelcomeScreen(appContainer); 
            } else if (currentView === 'roaster_tasks') {
                 // Removed ROASTER_TASKS view for non-anonymous mode
                 showMessage("Roaster Admin is disabled because anonymity is turned off.", true);
                 window.changeView('the_hit_list');
            } else if (currentView === 'reply_roast') {
                // NEW: Dedicated Reply Roast Page
                renderReplyRoastPage(appContainer);
            } else {
                // If logged in, always render the main inbox interface (The Hit List)
                renderMainInterface(appContainer);
            }
        };
        
        // --- NEW PAGE: Dedicated Anonymous Reply Screen (REMOVED, Logic is now handled by Home Base) ---
        // This function is kept as a stub to prevent errors if older code calls it
        const renderReplyRoastPage = (container) => {
            showMessage("Redirecting to Home Base for reply...", false);
            window.changeView('home_base');
        };
        // End NEW PAGE: Dedicated Anonymous Reply Screen
        
        
        // Page Name: Spawn Point (Rules)
        const renderRulesScreen = (container) => {
             container.className = 'w-full max-w-xl theme-black-bg p-8 rounded-xl border-white-thin';
             container.innerHTML = `
                 <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black">
                     <!-- Logo Placeholder -->
                     <img id="app-logo-rules" 
                          src="${BASE_IMAGE_URL}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                     <!-- END Logo Placeholder: Replace the 'src' above with your ImageBB URL -->
                     <h1 class="text-5xl font-extrabold theme-black-text">GOOFY AHH ROAST STATION</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Rules This Read</p>
                 </div>
                 
                 <!-- Rules Card: White BG, Black Text, Black Border -->
                 <div class="theme-white-bg p-6 rounded-xl shadow-lg border-2 border-black theme-black-text mb-8">
                     <ol class="list-decimal list-inside space-y-3 font-medium">
                         <li><span class="font-extrabold">Rule 1:</span> Users are expected to be appropriate and respectful; but if you are, congratulations — you failed the first rule.</li>
                         <li><span class="font-extrabold">Rule 2:</span> Crying is allowed, pictures of you crying are encouraged.</li>
                         <li><span class="font-extrabold">Rule 3:</span> Time to pay attention, even if you can't try to.... Always smile at the shadows dancing across your ceiling, even if the floor starts humming your secrets to the walls, while someone unseen rearranges the air around your thoughts, judging your every hesitation quietly...........Doesn't make sense? just like your productivity</li>
                         <li><span class="font-extrabold">Rule 4:</span> You’re still reading? Wow, dedication to wasting time, impressive as always.</li>
                     </ol>
                     <!-- NEW BOLD ANONYMITY TEXT -->
                     <p class="mt-6 text-center text-base font-extrabold theme-black-text">
                        Remember everything is anonymous
                     </p>
                     <p class="mt-2 text-center text-sm italic font-semibold">By continuing, you agree to be insulted, offended, and insult others.</p>
                 </div>
                 
                 <div class="space-y-4">
                     <!-- Button to proceed - CUSTOM TEXT ON THIS PAGE ONLY -->
                     <button onclick="window.acceptRules()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                         by clicking this button i agree that im gay
                     </button>
                 </div>
             `;
        };
        
        // Page Name: Useless Page (Name Input)
        const renderUselessPage = (container) => {
            // Check if the user has failed before
            const isHijacked = hasFailedUselessPage;
            
            // Set the input field properties based on the flag
            // Start with an empty value, then overwrite/hijack on focus/key up if needed
            const inputEvents = isHijacked ? 'onkeydown="return false;" onfocus="window.hijackInput(this)" onkeyup="window.hijackInput(this)"' : '';
            const inputValue = ''; // Always start with empty value
            const inputReadOnly = isHijacked ? '' : ''; // Don't set readonly initially
            
            // New sarcastic value hidden until input is triggered
            const sarcasticValue = "you really thought , i would give your lazy ass a second chance , click that button and gtfo";
            
            // Increased max-w-xl to max-w-2xl for more horizontal space
            container.className = 'w-full max-w-2xl theme-black-bg p-8 rounded-xl border-white-thin';
            container.innerHTML = `
                <!-- Logo Placeholder (Kept for continuity on this page) -->
                <img id="app-logo-useless-page" 
                     src="${getDynamicLogoUrl()}" 
                     alt="App Logo" 
                     class="w-24 h-24 mx-auto rounded-full border-4 border-white mb-8 object-cover">

                <!-- Content Card: Yellow BG, Black Text, Black Border -->
                <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black theme-black-text mb-8">
                    <h2 class="text-3xl font-bold mb-4 text-center">What is your name?</h2>
                    
                    <!-- Textarea: Used for multi-line support when hijacked -->
                    <textarea id="useless-name-input" rows="3" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black mb-6 resize-none" ${isHijacked ? 'onfocus="window.hijackInput(this)" onkeyup="window.hijackInput(this)"' : ''}></textarea>

                    <!-- Button: "I'm gay" style -->
                    <button onclick="window.processUselessName()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                        I'm gay
                    </button>
                </div>
            `;
        };
        
        // Page Name: Useless Roast Result
        const renderUselessResult = (container, data) => {
            // Updated to use passed data from processUselessName
            const enteredName = data && data.name ? data.name : "Unknown Entity";
            const roastLine = data && data.roast ? data.roast : "Error: Roast line missing.";
            // New flag to check if the user failed the name entry
            const userIsFriend = data && data.isFriend;
            
            // Determine the specific logo URL for the entered name
            const enteredNameLogoUrl = getDynamicLogoUrl(enteredName);

            // Determine the next button action based on whether the name was a friend's name
            let nextButtonHTML;
            if (userIsFriend) {
                // Success: Proceed to the Home Base
                nextButtonHTML = `
                    <button onclick="window.changeView('home_base')" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                        I'm gay
                    </button>
                `;
            } else {
                // Failure: Go back to the Useless Page for another try
                nextButtonHTML = `
                    <button onclick="window.changeView('useless_page')" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                        Go enter your name mf
                    </button>
                `;
            }
            
            // Increased max-w-xl to max-w-2xl for more horizontal space
            container.className = 'w-full max-w-2xl theme-black-bg p-8 rounded-xl border-white-thin';
            container.innerHTML = `
                <!-- Logo Placeholder: Uses the specific entered name's logo -->
                <img id="app-logo-useless-result" 
                     src="${enteredNameLogoUrl}" 
                     alt="App Logo" 
                     class="w-24 h-24 mx-auto rounded-full border-4 border-white mb-8 object-cover">
                
                <!-- Content Card: White BG, Black Text, Black Border -->
                <div class="theme-white-bg p-6 rounded-xl shadow-lg border-2 border-black theme-black-text mb-8 text-center">
                    <!-- The roast line itself, wrapped in the yellow box -->
                    <p class="text-3xl font-extrabold italic theme-yellow p-4 rounded-lg border-2 border-black theme-black-text">
                        ${roastLine}
                    </p>
                </div>
                
                <div class="space-y-4">
                    <!-- The conditional next button -->
                    ${nextButtonHTML}
                </div>
            `;
        };


        // Page Name: Home Base (Submission/Login screen)
        const renderWelcomeScreen = (container) => {
             // Main container for the welcome/submit view
             container.className = 'w-full max-w-4xl theme-black-bg p-4 rounded-xl border-white-thin';
             
             // All friends are potential senders and targets
             const allFriends = FRIENDS; 
             
             // Create friend buttons in the specified order: Shanmukh, Sahiti, Nikhil, Usmani
             const friendsList = [
                 'Shanmukh', 'Sahiti', 'Nikhil', 'Usmani'
             ].map(name => `
                <!-- Login Button: Uses the new login-button style (Yellow BG, Name Text) -->
                <button onclick="window.setUserName('${name}')" class="font-bold py-3 px-4 rounded-lg transition duration-200 login-button">
                    ${name} 
                </button>
             `).join('');

             const optionList = allFriends.map(name => `<option value="${name}">${name}</option>`).join('');
             
             // Determine if this is a reply redirect and set selected values
             let selectedSender = currentUserName || '';
             let selectedTarget = '';
             let replyMessage = '';
             
             // Check URL for reply target
             const urlTarget = getUrlParameter('replyTarget');

             if (urlTarget) {
                 selectedTarget = urlTarget;
                 replyMessage = `<p class="theme-black-text mb-3 font-semibold text-lg">Targeting the sender of the last roast you read: **${selectedTarget}**</p>`;
             }


             container.innerHTML = `
                <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black relative">
                      <!-- New button: Go Back To Spawn Point (Goes to the rules screen) -->
                     <button onclick="window.goToSpawnPoint()" class="absolute top-3 left-3 theme-black-bg theme-white-text font-semibold py-1 px-3 rounded-lg transition duration-200 border-2 border-white text-sm gay-button">
                         Go Back To Spawn Point
                     </button>

                     <!-- Logo Placeholder -->
                     <img id="app-logo-welcome" 
                          src="${getDynamicLogoUrl()}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                     <!-- END Logo Placeholder: Replace the 'src' above with your ImageBB URL -->
                     <h1 class="text-5xl font-extrabold theme-black-text">GOOFY AHH ROAST STATION</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Fuck someone or See how fucked up you are</p>
                 </div>
                 
                 <!-- Roast Submission Form (The immediate action) -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black mb-6">
                     <h2 class="text-3xl font-bold theme-black-text mb-4">Fuck someone anonymously</h2>
                     
                     ${replyMessage}

                     <!-- Sender Dropdown -->
                     <div class="mb-4">
                         <!-- UPDATED FONT SIZE AND BOLDNESS: text-xl font-extrabold -->
                         <label for="roast-sender-select" class="block text-xl font-extrabold theme-black-text mb-2">What do people yell at you?</label>
                          <!-- Input/Select: White BG, Black Text, Black Border -->
                         <select id="roast-sender-select" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black">
                             <option value=""></option> <!-- BLANK OPTION -->
                             ${optionList}
                         </select>
                     </div>
                     
                     <!-- Target Dropdown -->
                     <div class="mb-4">
                         <!-- UPDATED FONT SIZE AND BOLDNESS: text-xl font-extrabold -->
                         <label for="roast-target" class="block text-xl font-extrabold theme-black-text mb-2">Sand to</label>
                          <!-- Input/Select: White BG, Black Text, Black Border -->
                         <select id="roast-target" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black">
                             <option value=""></option> <!-- BLANK OPTION -->
                             ${optionList}
                         </select>
                     </div>
                     <div class="mb-6">
                         <!-- UPDATED FONT SIZE AND BOLDNESS: text-xl font-extrabold -->
                         <label for="roast-text" class="block text-xl font-extrabold theme-black-text mb-2">Write like you’ll deny it in court later :</label>
                          <!-- Textarea: White BG, Black Text, Black Border -->
                         <textarea id="roast-text" rows="4" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black" placeholder=""></textarea> 
                     </div>
                     <!-- Button: "Sand roast" style -->
                     <button onclick="window.submitRoast()" class="w-full font-extrabold text-xl py-3 rounded-lg shadow-md transition duration-300 sand-roast-button">
                         Sand roast
                     </button>
                 </div>
                 
                 <!-- Login/Inbox Access Section - NOW YELLOW BACKGROUND -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black">
                    <h2 class="text-xl font-bold theme-black-text mb-4 text-center">--- OR ---</h2>
                    <h2 class="text-2xl font-bold theme-black-text mb-4 text-center">check how much fucked up you are</h2>
                     <div class="grid grid-cols-2 gap-4">
                         ${friendsList}
                     </div>
                 </div>
             `;
             
             // --- POST-RENDER SCRIPT ---
             // Set pre-selected values if redirected for a reply
             const senderSelect = document.getElementById('roast-sender-select');
             const targetSelect = document.getElementById('roast-target');
             
             if (currentUserName && senderSelect) {
                 senderSelect.value = currentUserName;
             }
             if (selectedTarget && targetSelect) {
                 targetSelect.value = selectedTarget;
             }

        };

        // Page Name: The Hit List (Inbox)
        const renderRoastInboxView = () => {
             return `
                 <!-- Roast Inbox Card: Yellow BG, Black Text, Black Border -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black">
                     <h2 class="text-3xl font-bold theme-black-text mb-4">Inbox</h2>
                     <!-- Button to fetch roasts -->
                     <button onclick="window.getRoastsForInbox()" class="w-full font-extrabold py-3 rounded-lg shadow-md transition duration-300 gay-button">
                         Click to check messages
                     </button>
                      <!-- Display Box: Black BG, White Text, Black Border -->
                     <div id="roast-guess-box" class="mt-6 p-4 text-center theme-black-bg rounded-lg border-2 border-white">
                         <p class="text-gray-500 italic theme-white-text">Click the button above to check for new messages!</p>
                     </div>
                 </div>
             `;
        };
        
        // New: Roaster Task Management Interface
        const renderRoasterTaskInterface = (container) => {
             // Redirection for non-anonymous mode
             showMessage("Roaster Admin is disabled because anonymity is turned off.", true);
             window.changeView('the_hit_list');
        };


        const renderMainInterface = (container) => {
             // Main App Container: Black BG, White Border
             container.className = 'w-full max-w-4xl theme-black-bg p-4 rounded-xl border-white-thin';
             
             let contentHTML = renderRoastInboxView();
             let headerTitle = 'THE HIT LIST';

             container.innerHTML = `
                 <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black relative">
                     <!-- New button: Go Back To Spawn Point (Goes to the rules screen) -->
                     <button onclick="window.goToSpawnPoint()" class="absolute top-3 left-3 theme-black-bg theme-white-text font-semibold py-1 px-3 rounded-lg transition duration-200 border-2 border-white text-sm gay-button">
                         Go Back To Spawn Point
                     </button>

                     <!-- Logo Placeholder -->
                     <img id="app-logo-inbox" 
                          src="${getDynamicLogoUrl()}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                     <!-- END Logo Placeholder: Replace the 'src' above with your ImageBB URL -->

                     <!-- The existing "Change User" button logic is now handled by logOut() and this button -->
                     <h1 class="text-5xl font-extrabold theme-black-text">${headerTitle}</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Logged in as: **${currentUserName}**</p>
                     <p class="text-xs mt-2 theme-black-text">User ID: ${currentUserId}</p>
                 </div>

                 <!-- Navigation (Back to Send Roast) and Roaster Admin Link -->
                 <div class="mb-6 flex justify-between">
                     <!-- GO BACK button -->
                     <button onclick="window.logOut()" class="font-semibold py-2 px-4 rounded-lg transition duration-200 gay-button">
                         GO BACK
                     </button>
                     <!-- Roaster Admin is disabled, redirecting to home base -->
                     <button onclick="window.changeView('home_base')" class="font-semibold py-2 px-4 rounded-lg transition duration-200 login-button opacity-50">
                         ROASTER ADMIN (Disabled)
                     </button>
                 </div>

                 <!-- Main Content -->
                 <div id="main-content-area">
                     ${contentHTML}
                 </div>

                 <!-- Message Container for Feedback -->
                 <div id="message-container" class="fixed bottom-0 right-0 m-6"></div>
             `;
             // Start listening for inbox changes immediately after rendering the interface
             window.getRoastsForInbox();
        };


        // Initial setup
        window.onload = initializeFirebase;
    </script>

    <!-- Modal Root Container (for popups) -->
    <div id="modal-root"></div>
    
    <!-- Message Container for Feedback -->
    <div id="message-container" class="fixed bottom-0 right-0 m-6"></div>

    <div id="app-container" class="w-full max-w-lg theme-black-bg p-6 rounded-xl border-white-thin">
        <div class="text-center py-10 theme-white-text">
            <svg class="animate-spin h-8 w-8 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 004 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white">Loading App...</p>
        </div>
    </div>

</body>
</html>
