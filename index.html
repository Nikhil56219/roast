<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goofy ahh roast station</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        /* Global Style: Black Background, White Text */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111111; /* Main Background: Black */
            color: #FFFFFF; /* Default Text: White */
        }
        /* Custom colors based on user request */
        .theme-yellow { background-color: #FFD500; } /* Highlight Color */
        .theme-black-bg { background-color: #111111; }
        .theme-white-bg { background-color: #FFFFFF; }
        .theme-black-text { color: #000000; }
        .theme-white-text { color: #FFFFFF; }
        .border-white-thin { border: 1px solid #FFFFFF; } /* White Accent/Border */
        
        /* New Global Button Style for "I'm gay" (Used for navigation/actions unless overridden) */
        .gay-button {
             /* Black BG, White Text, White Border (Secondary style) */
             background-color: #111111 !important;
             color: #FFFFFF !important;
             border: 2px solid #FFFFFF !important;
             font-weight: 800; /* Extra bold */
             transition: all 0.2s;
        }
        .gay-button:hover {
             background-color: #FFFFFF !important;
             color: #000000 !important;
             border-color: #FFD500 !important;
        }

        /* Specific Sand Roast Button Style with Glow/Pulse Hover */
        .sand-roast-button {
            background-color: #111111 !important;
            color: #FFD500 !important;
            border: 2px solid #FFD500 !important;
            font-weight: 900;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(255, 213, 0, 0.5); /* Initial soft yellow shadow */
        }
        .sand-roast-button:hover {
            background-color: #FFD500 !important;
            color: #111111 !important;
            box-shadow: 0 0 15px #FFD500, 0 0 25px #FFD500; /* Intense glow */
            transform: scale(1.02);
        }
        
        /* Specific login button style (Yellow BG, Black Text, Black Border) */
        .login-button {
            background-color: #FFD500 !important;
            color: #000000 !important;
            border: 2px solid #000000 !important;
            font-weight: 800;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 #000000; /* Initial shadow */
        }
        .login-button:hover {
            background-color: #FFFFFF !important;
            color: #000000 !important;
            box-shadow: 6px 6px 0 #111111; /* Shifted shadow effect */
        }
        
        /* New style for the "Roast them back" button to make it pop */
        .roast-back-button {
            background-color: #FFD500 !important;
            color: #000000 !important;
            border: 2px solid #000000 !important;
            font-weight: 800;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 #000000;
        }
        .roast-back-button:hover {
            background-color: #FFFFFF !important;
            box-shadow: 6px 6px 0 #111111;
        }

        /* Large, Edgy Title Style */
        .roast-title {
            font-size: 3rem; /* Adjusted for better mobile fit */
            line-height: 1;
            text-shadow: 4px 4px #000000; /* Black shadow for cartoonish depth */
        }
        @media (min-width: 768px) {
            .roast-title {
                font-size: 4.5rem;
            }
        }
        
        /* Modal Overlay Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Dark background */
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Loading Animation Spinner */
        .roast-sending-spinner {
            border-top-color: #FFD500;
            border-right-color: transparent;
            border-bottom-color: #FFD500;
            border-left-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center items-start">

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, updateDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // --- GLOBAL CONSTANTS ---
        const IMAGE_URL = "https://i.ibb.co/27Rt9p5d/Whats-App-Image-2025-10-03-at-19-52-49-ce9f69b5.jpg";
        const appId = 'roast-station-app'; // Hardcoded unique identifier for your app's data path
        
        // ***************************************************************
        // !!! YOUR CONFIGURATION !!!
        // ***************************************************************
        const firebaseConfig = JSON.parse(
             '{"apiKey": "AIzaSyBiOzckIKs0VHntmesg51hUAgTuLXNXDyw", "authDomain": "ssun-3f880.firebaseapp.com", "projectId": "ssun-3f880", "storageBucket": "ssun-3f880.firebasestorage.app", "messagingSenderId": "858195643805", "appId": "1:858195643805:web:787f74900711c2babef374", "measurementId": "G-4R9Y40MET8"}'
        );
        // ***************************************************************
        
        const initialAuthToken = null; // No custom token needed for public deployment, using anonymous sign-in

        let app, db, auth, currentUserId = null, currentUserName = null;
        // FIX: Global state variable for fetched roasts is initialized here to prevent ReferenceError
        let fetchedRoasts = []; 
        
        // --- PERSISTENCE FLAG: Tracks if the user failed the name entry once ---
        let hasFailedUselessPage = false; 
        
        // Page Names: 'spawn_point' (Rules), 'useless_page' (Name Input), 'useless_result' (Name Roast), 'home_base' (Submit/Login), 'the_hit_list' (Inbox), 'roaster_tasks' (Task Admin)
        let currentView = 'spawn_point'; 
        
        // UPDATED FRIEND NAMES (Original names used for display/login/target)
        const FRIENDS = ['Nikhil', 'Sahiti', 'Shanmukh', 'Usmani'];
        
        // List of all possible random roasts for the Useless Page (If friend name entered)
        const FRIEND_ROAST_LINES = [
            "How do I even pronounce this disaster?",
            "Who hurt you enough to pick this name?",
            "Did your parents lose a bet?",
            "Are you sure this isnâ€™t a typo?",
            "This sounds like a failed WiFi password.",
            "And people call you by this voluntarily?",
            "You really looked at that name and said â€˜yeah, this works.â€™",
            "Sounds like your parents picked letters out of a Scrabble bag.",
            "Iâ€™ve seen better names on spam emails.",
            "Your name sounds like an expired coupon code."
        ];
        
        // List of failure roasts (If non-friend name entered)
        const FAILURE_ROAST_LINES = [
            "Wowâ€¦ you really failed at the easiest part",
            "Not even this small thing",
            "Canâ€™t handle one little question?",
            "Seriouslyâ€¦ you canâ€™t type your name?",
            "Even this is too much?",
            "Wowâ€¦ too hard for you",
            "you canâ€™t answer a simple questionâ€¦",
            "Canâ€™t type your own name, huh?",
            "Not even this basic task?"
        ];


        // --- Utility Functions ---
        const getRoastCollectionRef = () => {
            if (!db) return null;
            // Public collection path: /artifacts/{appId}/public/data/roasts
            return collection(db, `artifacts/${appId}/public/data/roasts`);
        };
        
        const getTaskCollectionRef = () => {
             if (!db) return null;
             // Public collection path for reveal tasks
             return collection(db, `artifacts/${appId}/public/data/reveal_tasks`);
        };


        const getFriendProfileRef = (uid) => {
             if (!db) return null;
             // Private user profile path: /artifacts/{appId}/users/{userId}/profiles/current
             // Note: Using public path for simplicity in a deployed environment where all users are anonymous/ephemeral
             return doc(db, `artifacts/${appId}/users/${uid}/profiles/current`);
        }
        
        const generateTaskCode = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        };

        const showMessage = (message, isError = false) => {
            const container = document.getElementById('message-container');
            // Yellow background, Black text for success/info. Red for error.
            container.innerHTML = `<div class="p-3 mt-4 rounded-lg text-sm font-semibold shadow-md ${isError ? 'bg-red-500 text-white' : 'theme-yellow theme-black-text'}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        };

        // --- Authentication and Initialization ---
        const initializeFirebase = async () => {
            if (firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    await new Promise(resolve => {
                        const unsubscribe = onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                currentUserId = user.uid;
                                console.log('Authenticated user:', currentUserId);
                                await loadUserName();
                                unsubscribe();
                                resolve();
                            } else {
                                console.log('No user signed in. Attempting sign-in anonymously...');
                                try {
                                    // Attempt sign in anonymously
                                    await signInAnonymously(auth);
                                } catch (error) {
                                    console.error("Anonymous Sign-in Failed:", error);
                                    if (error.code === 'auth/configuration-not-found') {
                                        showMessage("Auth Error: Authentication is not enabled. Please enable **Anonymous** sign-in in your Firebase console (Authentication > Sign-in method).", true);
                                    } else {
                                        showMessage(`Auth Error: ${error.message}`, true);
                                    }
                                } finally {
                                    unsubscribe();
                                    resolve();
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    showMessage(`Error initializing app: ${error.message}`, true);
                }
            } else {
                showMessage("Firebase configuration is missing. Please ensure you have replaced the placeholder config with your actual Firebase project details.", true);
            }
        };

        const loadUserName = async () => {
             if (!db || !currentUserId) return;
             try {
                 const profileDoc = await getDoc(getFriendProfileRef(currentUserId));
                 if (profileDoc.exists()) {
                     currentUserName = profileDoc.data().name;
                     console.log('User Name loaded:', currentUserName);
                 }
                 renderApp();
             } catch (error) {
                 console.error("Error loading user name:", error);
                 showMessage("Could not load your profile. Try reloading.", true);
             }
         };

        const setUserName = async (name) => {
            if (!db || !currentUserId) return;
            try {
                // Save name to private user profile and navigate to inbox
                await setDoc(getFriendProfileRef(currentUserId), { name: name });
                currentUserName = name;
                console.log('User Name set:', currentUserName);
                window.changeView('the_hit_list'); 
            } catch (error) {
                console.error("Error setting user name:", error);
                showMessage("Could not save your name. Try again.", true);
            }
        };
        
        // Function to clear user name and return to the submission/login screen (Home Base)
        window.logOut = () => {
             currentUserName = null;
             currentView = 'home_base'; // Go back to the submit/login screen
             renderApp();
        };

        // --- Core Application Logic (Roast Submission/Inbox) ---

        const showRoastSentModal = (targetName) => {
            const modalHTML = `
                <div class="modal-overlay" onclick="document.getElementById('modal-root').innerHTML = ''">
                    <div class="theme-yellow p-8 rounded-xl shadow-2xl border-4 border-black text-center max-w-sm" onclick="event.stopPropagation()">
                        
                        <!-- Logo Placeholder in Modal -->
                        <img src="${IMAGE_URL}" 
                             alt="Modal Logo" 
                             class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                        
                        <h2 class="text-5xl font-extrabold theme-black-text mb-6">ROAST SENT!</h2>
                        
                        <!-- Button is I'm gay (gay-button style) -->
                        <button onclick="document.getElementById('modal-root').innerHTML = ''" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                            I'm gay
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-root').innerHTML = modalHTML;
        };


        const submitRoast = async (targetName, roastText, senderName) => {
            const submitButton = document.querySelector('.sand-roast-button') || document.querySelector('#reply-roast-button');
            const isReply = submitButton && submitButton.id === 'reply-roast-button';

            if (!senderName || !targetName || !roastText) {
                showMessage("Please select a sender, target, and write a roast.", true);
                return;
            }

            if (senderName === targetName) {
                showMessage("You can't roast yourself! Pick a friend.", true);
                return;
            }

            // Show sending animation
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="roast-sending-spinner w-6 h-6 border-4 rounded-full mx-auto"></div>`;

            try {
                // Simulate delay for animation visibility (1.5 seconds)
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                await addDoc(getRoastCollectionRef(), {
                    target: targetName,
                    senderName: senderName, // Stored for the reveal/guess
                    roastText: roastText,
                    isRead: false, 
                    isRevealed: false, // New flag for reveal status
                    createdAt: new Date()
                });
                
                // If this was a reply, close the modal; otherwise, show the main success modal
                if (isReply) {
                    window.closeModal();
                    showMessage("Retaliation sand successfully!", false);
                } else {
                    // This is the main submission flow
                    showRoastSentModal(targetName); 
                    // Clear inputs for main form only
                    document.getElementById('roast-text').value = ''; 
                    const senderSelectElement = document.getElementById('roast-sender-select');
                    if (senderSelectElement) senderSelectElement.value = ''; 
                    document.getElementById('roast-target').value = ''; 
                }
            } catch (error) {
                console.error("Error submitting roast:", error);
                showMessage("Failed to submit roast. Check console for details.", true);
            } finally {
                // Reset button regardless of success/failure
                submitButton.disabled = false;
                submitButton.textContent = isReply ? "Sand Reply Roast" : "Sand roast";
            }
        };

        // Main form submission wrapper
        const handleMainRoastSubmission = () => {
            const targetName = document.getElementById('roast-target').value;
            const roastText = document.getElementById('roast-text').value.trim();
            const senderSelectElement = document.getElementById('roast-sender-select');
            const determinedSender = currentUserName || (senderSelectElement ? senderSelectElement.value : null);
            
            submitRoast(targetName, roastText, determinedSender);
        };
        
        // Function to fetch all roasts and display them in a list format
        const getRoastsForInbox = async () => {
             if (!db || !currentUserName) return;
             
             // The inbox list will replace the button
             const inboxContainer = document.getElementById('roast-guess-box'); 
             inboxContainer.innerHTML = `<p class="text-xl font-semibold theme-black-text">Fetching roasts...</p>`;

             try {
                 // Query for ALL roasts targeted at the current user
                 const q = query(getRoastCollectionRef(), where("target", "==", currentUserName));
                 const snapshot = await getDocs(q);

                 if (snapshot.empty) {
                     inboxContainer.innerHTML = `<p class="text-xl font-semibold theme-black-text">ðŸŽ‰ Inbox empty. Looks like you're safe (for now)!</p>`;
                     return;
                 }
                 
                 // Collect and sort roasts by creation date (newest first) in memory
                 fetchedRoasts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 fetchedRoasts.sort((a, b) => b.createdAt.toDate().getTime() - a.createdAt.toDate().getTime()); // Sort by newest first

                 const messageListHTML = fetchedRoasts.map((roast, index) => {
                     // Get formatted time and date
                     const date = roast.createdAt.toDate();
                     const dateStr = date.toLocaleDateString();
                     const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                     const dateTimeStr = `${dateStr} ${timeStr}`;

                     // Determine if the message has been revealed to change the title appearance
                     const titleText = roast.isRevealed ? roast.senderName : '***';

                     return `
                     <!-- Message Card: Clicking reveals the detail modal -->
                     <div class="p-4 mb-3 rounded-lg border-2 border-black cursor-pointer ${roast.isRevealed ? 'theme-yellow opacity-75' : 'theme-white-bg'}" 
                          onclick="showRoastDetailModal(${index})">
                         <div class="flex justify-between items-start mb-2">
                             <!-- Sender/Anonymity Title -->
                             <span class="font-extrabold text-lg theme-black-text">${titleText}</span>
                             <!-- Date/Time Display -->
                             <span class="text-xs theme-black-text">${dateTimeStr}</span>
                         </div>
                         <!-- Roast Text Preview -->
                         <p class="font-medium text-base theme-black-text">${roast.roastText.substring(0, 50)}${roast.roastText.length > 50 ? '...' : ''}</p>
                         <p class="text-right text-xs mt-2 theme-black-text italic">${roast.isRevealed ? 'â€” Revealed' : (roast.isRead ? 'â€” Read' : 'â€” New')}</p>
                     </div>
                 `;
                 }).join('');

                 inboxContainer.innerHTML = `<div class="max-h-96 overflow-y-scroll p-2 theme-black-bg">${messageListHTML}</div>`;

             } catch (error) {
                 console.error("Error fetching roast inbox:", error);
                 showMessage("Failed to fetch roast inbox.", true);
             }
         };
         
        // Function to mark a roast as read (called when the detail modal is opened)
         window.markRoastAsRead = async (roastId) => {
             try {
                 const roastRef = doc(getRoastCollectionRef(), roastId);
                 // Only update if it's currently unread
                 const docSnap = await getDoc(roastRef);
                 if (docSnap.exists() && !docSnap.data().isRead) {
                    await updateDoc(roastRef, { isRead: true });
                 }
             } catch (error) {
                 console.error("Failed to mark roast as read:", error);
             }
         };

        // Renders the reply form inside the modal
        window.renderReplyRoastForm = (roast) => {
            const modalContent = document.getElementById('roast-detail-content');
            
            // Note: The roast sender is still anonymous to the user, but we know it for targeting the reply
            const targetSender = roast.senderName; 
            const replyingAs = roast.target; // The person being roasted is the sender of the reply
            
            modalContent.innerHTML = `
                <h2 class="text-3xl font-extrabold mb-4 theme-black-text">REVENGE ROAST!</h2>
                <p class="text-lg font-semibold mb-4 theme-black-text">Sand an anonymous reply back to the coward who sent this.</p>
                
                <div class="mb-6">
                    <label for="reply-roast-text" class="block text-xl font-extrabold theme-black-text mb-2">Write like youâ€™ll deny it in court later :</label>
                    <textarea id="reply-roast-text" rows="4" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black" placeholder=""></textarea> 
                </div>

                <button id="reply-roast-button" onclick="handleReplyRoastSubmission('${targetSender}', '${replyingAs}')" 
                        class="w-full font-extrabold text-xl py-3 rounded-lg shadow-md transition duration-300 sand-roast-button mb-4">
                    Sand Reply Roast
                </button>
                
                <button onclick="window.closeModal()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                    Close
                </button>
            `;
        };

        // Wrapper function to handle reply submission
        const handleReplyRoastSubmission = (targetSender, replyingAs) => {
            const roastText = document.getElementById('reply-roast-text').value.trim();
            // In a reply: target is the original sender, sender is the current user
            submitRoast(targetSender, roastText, replyingAs);
        };
         
         // Function to show the roast detail and the task/reveal status
         window.showRoastDetailModal = async (index) => {
             // Access the global fetchedRoasts array
             const roast = fetchedRoasts[index];
             if (!roast) return;
             
             // Mark as read and refresh the list in the background
             await window.markRoastAsRead(roast.id);
             getRoastsForInbox();
             
             const modalRoot = document.getElementById('modal-root');
             
             // Check task status
             let taskStatus = await getTaskStatus(roast.id);
             
             // Generate Modal Content based on task status
             const getTaskUI = (roast, taskStatus) => {
                 // --- Reveal Status Check ---
                 if (roast.isRevealed) {
                     return `
                         <p class="text-3xl font-extrabold text-red-500 mb-4">IDENTIY REVEALED!</p>
                         <p class="text-xl font-semibold mb-4 theme-black-text">It was the coward: **${roast.senderName}**</p>
                     `;
                 }
                 
                 // --- Task Status UI ---
                 let revealButtonHTML = '';
                 let taskInputHTML = '';
                 
                 if (!taskStatus) { // No request sent yet (task_pending)
                     revealButtonHTML = `
                         <button id="reveal-button" 
                                 onclick="requestRoasterReveal('${roast.id}', '${roast.target}', '${roast.senderName}')" 
                                 class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 login-button mb-4">
                             Want to know who sand this?
                         </button>
                     `;
                 } else if (taskStatus.status === 'task_pending') { // Task requested, Roaster hasn't responded
                     revealButtonHTML = `<button disabled class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 login-button opacity-50 mb-4">
                         Task request is sent to roaster, wait for the task...
                     </button>`;
                 } else if (taskStatus.status === 'task_given') { // Task assigned, waiting for code entry
                     revealButtonHTML = `<p class="text-lg font-bold text-red-500 mb-2">TASK: ${taskStatus.taskDescription}</p>`;
                     taskInputHTML = `
                         <input id="task-code-input" type="text" placeholder="Enter Task Code (e.g., A1B2C3)" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black text-center text-2xl font-bold mb-4">
                         <button onclick="submitTaskCode('${roast.id}')" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 login-button mb-4">
                             I'm gay (Submit Code)
                         </button>
                     `;
                 } else if (taskStatus.status === 'task_completed') {
                      revealButtonHTML = `<p class="text-xl font-bold text-green-500 mb-4">TASK COMPLETED. Revealing Identity...</p>`;
                      // This state means the roast.isRevealed should be true, handled by the first if block
                 }

                 return `
                     <!-- Roast Text in Yellow Box -->
                     <p class="text-xl font-medium mb-4 p-4 theme-yellow rounded-lg italic theme-black-text text-left">${roast.roastText}</p>
                     
                     <!-- Buttons for Roast Back and Reveal/Close -->
                     <div class="grid grid-cols-3 gap-2 mb-4">
                         <button onclick="window.renderReplyRoastForm(fetchedRoasts[${index}])" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 roast-back-button">
                             Roast them back
                         </button>
                         <button onclick="window.closeModal()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                             Close
                         </button>
                         <button onclick="window.requestRoasterReveal('${roast.id}', '${roast.target}', '${roast.senderName}')" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 login-button">
                             Want to know who sand this?
                         </button>
                     </div>

                     ${taskInputHTML}
                     ${revealButtonHTML}
                 `;
             };


             modalRoot.innerHTML = `
                 <div class="modal-overlay" onclick="closeModal()">
                     <div id="roast-detail-container" class="theme-white-bg p-8 rounded-xl shadow-2xl border-4 border-black text-center max-w-lg theme-black-text" onclick="event.stopPropagation()">
                         <h2 class="text-3xl font-extrabold mb-4">YOU'VE BEEN ROASTED!</h2>
                         <div id="roast-detail-content">
                            ${getTaskUI(roast, taskStatus)}
                         </div>
                         
                     </div>
                 </div>
             `;
         };
         
         // Helper function to get the current task status for a roast
         const getTaskStatus = async (roastId) => {
             if (!db) return null;
             try {
                 const q = query(getTaskCollectionRef(), where("roastId", "==", roastId));
                 const snapshot = await getDocs(q);
                 if (!snapshot.empty) {
                     return { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                 }
                 return null;
             } catch (error) {
                 console.error("Error fetching task status:", error);
                 return null;
             }
         };

         // 1. ROASTED USER: Requests the task (triggers task creation)
         window.requestRoasterReveal = async (roastId, targetName, senderName) => {
             const revealButton = document.getElementById('reveal-button');
             revealButton.textContent = "Task request is sent to roaster, wait for the task...";
             revealButton.disabled = true;
             revealButton.classList.remove('login-button');
             revealButton.classList.add('gay-button', 'opacity-50');

             try {
                 await addDoc(getTaskCollectionRef(), {
                     roastId: roastId,
                     targetName: targetName, // Person who got roasted
                     senderName: senderName, // Person who sent the roast (will assign task)
                     status: 'task_pending',
                     createdAt: new Date(),
                     taskCode: null,
                     taskDescription: null,
                 });
                 // Keep the modal open to show the user the status has updated
             } catch (error) {
                 showMessage("Failed to send reveal request.", true);
                 console.error(error);
             }
         };
         
         // 2. ROASTED USER: Submits the task code
         window.submitTaskCode = async (roastId) => {
             const code = document.getElementById('task-code-input').value.trim().toUpperCase();
             if (code.length === 0) {
                 showMessage("Enter the task code, you chicken.", true);
                 return;
             }

             const taskStatus = await getTaskStatus(roastId);
             if (!taskStatus) {
                 showMessage("No task found for this roast.", true);
                 return;
             }
             
             if (taskStatus.taskCode === code) {
                 // Correct code! Reveal identity and mark both roast and task complete.
                 await updateDoc(doc(getRoastCollectionRef(), roastId), { isRevealed: true });
                 await updateDoc(doc(getTaskCollectionRef(), taskStatus.id), { status: 'task_completed' });
                 
                 showMessage(`Identity revealed! The coward was ${taskStatus.senderName}!`, false);
                 closeModal();
                 // Re-render the detail modal to show the revealed name immediately
                 getRoastsForInbox();
             } else {
                 showMessage("Wrong code. You didn't complete the task, failure.", true);
             }
         };
         
         // 3. ROASTER: Generates the task code (from Roaster Tasks Dashboard)
         window.generateTask = async (taskDocId, roastId, senderName) => {
             const taskInput = document.getElementById(`task-input-${taskDocId}`).value.trim();
             if (taskInput.length === 0) {
                 showMessage("You must assign a task!", true);
                 return;
             }
             
             const taskCode = generateTaskCode();
             
             try {
                 await updateDoc(doc(getTaskCollectionRef(), taskDocId), {
                     status: 'task_given',
                     taskDescription: taskInput,
                     taskCode: taskCode,
                 });
                 
                 showMessage(`Task assigned and code generated: ${taskCode}`, false);
                 // Re-render the list immediately
                 window.getRoasterTasks(); 
             } catch (error) {
                 showMessage("Failed to assign task.", true);
                 console.error(error);
             }
         };
         
         // Function to fetch tasks assigned TO the current user (if current user is the roaster/sender)
         window.getRoasterTasks = async () => {
             if (!db || !currentUserName) return;
             
             const taskContainer = document.getElementById('roaster-task-list');
             taskContainer.innerHTML = `<p class="theme-black-text">Fetching tasks you need to assign...</p>`;

             try {
                 // Fetch tasks where the current user is the sender (roaster) and the task hasn't been completed
                 const q = query(getTaskCollectionRef(), 
                                 where("senderName", "==", currentUserName), 
                                 where("status", "!=", "task_completed"));
                 const snapshot = await getDocs(q);

                 if (snapshot.empty) {
                     taskContainer.innerHTML = `<p class="theme-black-text">Your hands are clean (for now).</p>`;
                     return;
                 }
                 
                 const taskListHTML = snapshot.docs.map(doc => {
                     const task = { id: doc.id, ...doc.data() };
                     
                     let taskUI;
                     if (task.status === 'task_pending') {
                         // Pending assignment: Show input fields
                         taskUI = `
                             <input id="task-input-${task.id}" type="text" placeholder="e.g., Send a silly face selfie to the group chat" class="w-full p-2 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black mb-3">
                             <button onclick="window.generateTask('${task.id}', '${task.roastId}', '${task.senderName}')" class="w-full font-extrabold py-2 rounded-lg shadow-md transition duration-300 login-button">
                                 Assign Task & Generate Code
                             </button>
                         `;
                     } else if (task.status === 'task_given') {
                         // Task assigned: Show task and code
                         taskUI = `
                             <p class="font-bold text-lg">TASK: <span class="text-red-500">${task.taskDescription}</span></p>
                             <p class="font-bold text-xl mt-2">CODE: <span class="theme-yellow theme-black-text p-1 rounded">${task.taskCode}</span></p>
                             <p class="text-sm mt-1 text-gray-700">Waiting for ${task.targetName} to submit this code...</p>
                         `;
                     }
                     
                     return `
                         <div class="p-4 mb-4 rounded-lg border-2 border-black theme-yellow">
                             <h3 class="font-bold text-xl theme-black-text mb-2">ðŸ”¥ Reveal Request from ${task.targetName}</h3>
                             <p class="text-sm theme-black-text mb-3">Roast ID: ${task.roastId.substring(0, 8)}...</p>
                             ${taskUI}
                         </div>
                     `;
                 }).join('');

                 taskContainer.innerHTML = `<div class="max-h-96 overflow-y-scroll p-2">${taskListHTML}</div>`;

             } catch (error) {
                 console.error("Error fetching roaster tasks:", error);
                 taskContainer.innerHTML = `<p class="theme-black-text text-red-500">Error fetching your tasks.</p>`;
             }
         };
         
         window.goToRoasterTasks = () => {
             window.changeView('roaster_tasks');
         };
         
         window.goToInbox = () => {
             window.changeView('the_hit_list');
         };


        // --- Page Navigation and Rendering Setup ---
        
        // Function to move from rules screen (Spawn Point) to the useless name page
        window.acceptRules = () => {
            currentView = 'useless_page'; 
            renderApp();
        };
        
        // Function to process the name input from the useless page
        window.processUselessName = () => {
            const inputElement = document.getElementById('useless-name-input');
            const enteredName = inputElement.value.trim();

            if (!enteredName) {
                showMessage("Seriously? Enter your pathetic name.", true);
                return;
            }
            
            // If the input is already hijacked, the user intended to proceed (since they can't type)
            if (inputElement.readOnly) {
                window.changeView('home_base');
                return;
            }

            // --- Case-Insensitive Check ---
            const isFriend = FRIENDS.some(f => f.toLowerCase() === enteredName.toLowerCase());

            let roast;
            if (isFriend) {
                // If friend, choose a random FRIEND roast
                roast = FRIEND_ROAST_LINES[Math.floor(Math.random() * FRIEND_ROAST_LINES.length)];
            } else {
                // If non-friend, choose a random FAILURE roast
                roast = FAILURE_ROAST_LINES[Math.floor(Math.random() * FAILURE_ROAST_LINES.length)];
                hasFailedUselessPage = true; // Set the flag to true on the first failure
            }

            window.changeView('useless_result', { name: enteredName, roast: roast, isFriend: isFriend }); // Pass isFriend flag
        };
        
        // Custom changeView function to handle data passing
        window.changeView = (newView, data = null) => {
             currentView = newView;
             renderApp(data);
        };
        
        // --- INPUT HIJACKING LOGIC ---
        // Function called when the user focuses/types in the input field AFTER first failure
        window.hijackInput = (inputElement) => {
            const sarcasticMessage = "you really thought , i would give your lazy ass a second chance , click that button and gtfo";
            
            // Only hijack if the flag is set AND the field isn't already readOnly
            if (hasFailedUselessPage && !inputElement.readOnly) {
                inputElement.value = sarcasticMessage;
                // Lock the field after the message is displayed
                inputElement.readOnly = true; 
            }
        };


        // Expose functions to the window so they can be called from inline HTML
        window.submitRoast = handleMainRoastSubmission;
        window.handleReplyRoastSubmission = handleReplyRoastSubmission;
        window.renderReplyRoastForm = renderReplyRoastForm;
        window.setUserName = setUserName;
        window.logOut = logOut; 
        window.getRoastsForInbox = getRoastsForInbox; 
        window.markRoastAsRead = markRoastAsRead; 
        window.showRoastDetailModal = showRoastDetailModal; 
        window.requestRoasterReveal = requestRoasterReveal; // Corrected exposure
        window.closeModal = () => { document.getElementById('modal-root').innerHTML = ''; getRoastsForInbox(); }; // Enhanced closeModal
        window.goToSpawnPoint = () => { currentUserName = null; currentView = 'spawn_point'; renderApp(); };
        window.goToRoasterTasks = goToRoasterTasks;
        window.goToInbox = goToInbox;
        window.generateTask = generateTask;
        window.submitTaskCode = submitTaskCode;
        window.getRoasterTasks = getRoasterTasks;

        // --- View Rendering ---

        const renderApp = (data = null) => {
            const appContainer = document.getElementById('app-container');
            if (currentView === 'spawn_point') {
                renderRulesScreen(appContainer);
            } else if (currentView === 'useless_page') {
                renderUselessPage(appContainer);
            } else if (currentView === 'useless_result') {
                renderUselessResult(appContainer, data); // Pass data (name)
            } else if (!currentUserName) {
                // If not logged in and past rules, show submit/login screen (Home Base)
                renderWelcomeScreen(appContainer); 
            } else if (currentView === 'roaster_tasks') {
                 // New Roaster Task View
                 renderRoasterTaskInterface(appContainer);
            } else {
                // If logged in, always render the main inbox interface (The Hit List)
                renderMainInterface(appContainer);
            }
        };

        // Page Name: Spawn Point (Rules)
        const renderRulesScreen = (container) => {
             container.className = 'w-full max-w-xl theme-black-bg p-8 rounded-xl border-white-thin';
             container.innerHTML = `
                 <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black">
                     <!-- Logo Placeholder -->
                     <img id="app-logo-rules" 
                          src="${IMAGE_URL}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                     <!-- END Logo Placeholder: Replace the 'src' above with your ImageBB URL -->
                     <h1 class="text-5xl font-extrabold theme-black-text">GOOFY AHH ROAST STATION</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Rules This Read</p>
                 </div>
                 
                 <!-- Rules Card: White BG, Black Text, Black Border -->
                 <div class="theme-white-bg p-6 rounded-xl shadow-lg border-2 border-black theme-black-text mb-8">
                     <ol class="list-decimal list-inside space-y-3 font-medium">
                         <li><span class="font-extrabold">Rule 1: Thou Shalt Not Be Appropriate.</span> We strictly enforce the opposite of respect. If your roast isn't highly questionable, delete it and start over.</li>
                         <li><span class="font-extrabold">Rule 2: Anonymity is Cowardice.</span> The roast sender is hidden, but the goal is to *unmask* them. If you guess wrong, the resulting shame is entirely your burden.</li>
                         <li><span class="font-extrabold">Rule 3: Retaliation is Mandatory.</span> If you receive a roast, you must send one back immediately. Failure to participate earns you the title of **Certified Wet Sock** of the friend group.</li>
                     </ol>
                     <p class="mt-6 text-center text-sm italic font-semibold">By continuing, you agree to look like a proper idiot and contribute to the chaos.</p>
                 </div>
                 
                 <div class="space-y-4">
                     <!-- Button to proceed -->
                     <button onclick="window.acceptRules()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                         I'm gay
                     </button>
                 </div>
             `;
        };
        
        // Page Name: Useless Page (Name Input)
        const renderUselessPage = (container) => {
            // Check if the user has failed before
            const isHijacked = hasFailedUselessPage;
            
            // Set the input field properties based on the flag
            // Start with an empty value, then overwrite/hijack on focus/key up if needed
            const inputEvents = isHijacked ? 'onkeydown="return false;" onfocus="window.hijackInput(this)" onkeyup="window.hijackInput(this)"' : '';
            const inputValue = ''; // Always start with empty value
            const inputReadOnly = isHijacked ? '' : ''; // Don't set readonly initially
            
            // New sarcastic value hidden until input is triggered
            const sarcasticValue = "you really thought , i would give your lazy ass a second chance , click that button and gtfo";
            
            // Increased max-w-xl to max-w-2xl for more horizontal space
            container.className = 'w-full max-w-2xl theme-black-bg p-8 rounded-xl border-white-thin';
            container.innerHTML = `
                <!-- Logo Placeholder (Kept for continuity on this page) -->
                <img id="app-logo-useless-page" 
                     src="${IMAGE_URL}" 
                     alt="App Logo" 
                     class="w-24 h-24 mx-auto rounded-full border-4 border-white mb-8 object-cover">

                <!-- Content Card: Yellow BG, Black Text, Black Border -->
                <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black theme-black-text mb-8">
                    <h2 class="text-3xl font-bold mb-4 text-center">What is your name?</h2>
                    
                    <!-- Textarea: Used for multi-line support when hijacked -->
                    <textarea id="useless-name-input" rows="3" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black mb-6 resize-none" ${isHijacked ? 'onfocus="window.hijackInput(this)" onkeyup="window.hijackInput(this)"' : ''}></textarea>

                    <!-- Button: "I'm gay" style -->
                    <button onclick="window.processUselessName()" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                        I'm gay
                    </button>
                </div>
            `;
        };
        
        // Page Name: Useless Roast Result
        const renderUselessResult = (container, data) => {
            // Updated to use passed data from processUselessName
            const enteredName = data && data.name ? data.name : "Unknown Entity";
            const roastLine = data && data.roast ? data.roast : "Error: Roast line missing.";
            // New flag to check if the user failed the name entry
            const userIsFriend = data && data.isFriend;

            // Determine the next button action based on whether the name was a friend's name
            let nextButtonHTML;
            if (userIsFriend) {
                // Success: Proceed to the Home Base
                nextButtonHTML = `
                    <button onclick="window.changeView('home_base')" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                        I'm gay
                    </button>
                `;
            } else {
                // Failure: Go back to the Useless Page for another try
                nextButtonHTML = `
                    <button onclick="window.changeView('useless_page')" class="w-full text-xl py-4 rounded-lg shadow-md transition duration-300 gay-button">
                        Go enter your name mf
                    </button>
                `;
            }
            
            // Increased max-w-xl to max-w-2xl for more horizontal space
            container.className = 'w-full max-w-2xl theme-black-bg p-8 rounded-xl border-white-thin';
            container.innerHTML = `
                <!-- Logo Placeholder -->
                <img id="app-logo-useless-result" 
                     src="${IMAGE_URL}" 
                     alt="App Logo" 
                     class="w-24 h-24 mx-auto rounded-full border-4 border-white mb-8 object-cover">
                
                <!-- Content Card: White BG, Black Text, Black Border -->
                <div class="theme-white-bg p-6 rounded-xl shadow-lg border-2 border-black theme-black-text mb-8 text-center">
                    <!-- The roast line itself, wrapped in the yellow box -->
                    <p class="text-3xl font-extrabold italic theme-yellow p-4 rounded-lg border-2 border-black theme-black-text">
                        ${roastLine}
                    </p>
                </div>
                
                <div class="space-y-4">
                    <!-- The conditional next button -->
                    ${nextButtonHTML}
                </div>
            `;
        };


        // Page Name: Home Base (Submission/Login screen)
        const renderWelcomeScreen = (container) => {
             // Main container for the welcome/submit view
             container.className = 'w-full max-w-4xl theme-black-bg p-4 rounded-xl border-white-thin';
             
             // All friends are potential senders and targets
             const allFriends = FRIENDS; 
             
             const friendsList = allFriends.map(name => `
                <!-- Login Button: Uses the new login-button style (Yellow BG, Name Text) -->
                <button onclick="window.setUserName('${name}')" class="font-bold py-3 px-4 rounded-lg transition duration-200 login-button">
                    ${name} 
                </button>
             `).join('');

             const optionList = allFriends.map(name => `<option value="${name}">${name}</option>`).join('');

             container.innerHTML = `
                <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black relative">
                      <!-- New button: Go Back To Spawn Point (Goes to the rules screen) -->
                     <button onclick="window.goToSpawnPoint()" class="absolute top-3 left-3 theme-black-bg theme-white-text font-semibold py-1 px-3 rounded-lg transition duration-200 border-2 border-white text-sm gay-button">
                         Go Back To Spawn Point
                     </button>

                     <!-- Logo Placeholder -->
                     <img id="app-logo-welcome" 
                          src="${IMAGE_URL}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                     <!-- END Logo Placeholder: Replace the 'src' above with your ImageBB URL -->
                     <h1 class="text-5xl font-extrabold theme-black-text">GOOFY AHH ROAST STATION</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Fuck someone or See how fucked up you are</p>
                 </div>
                 
                 <!-- Roast Submission Form (The immediate action) -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black mb-6">
                     <h2 class="text-3xl font-bold theme-black-text mb-4">Fuck someone anonymously</h2>
                     
                     <!-- Sender Dropdown -->
                     <div class="mb-4">
                         <!-- UPDATED FONT SIZE AND BOLDNESS: text-xl font-extrabold -->
                         <label for="roast-sender-select" class="block text-xl font-extrabold theme-black-text mb-2">What do people yell at you?</label>
                          <!-- Input/Select: White BG, Black Text, Black Border -->
                         <select id="roast-sender-select" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black">
                             <option value=""></option> <!-- BLANK OPTION -->
                             ${optionList}
                         </select>
                     </div>
                     
                     <!-- Target Dropdown -->
                     <div class="mb-4">
                         <!-- UPDATED FONT SIZE AND BOLDNESS: text-xl font-extrabold -->
                         <label for="roast-target" class="block text-xl font-extrabold theme-black-text mb-2">Sand to</label>
                          <!-- Input/Select: White BG, Black Text, Black Border -->
                         <select id="roast-target" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black">
                             <option value=""></option> <!-- BLANK OPTION -->
                             ${optionList}
                         </select>
                     </div>
                     <div class="mb-6">
                         <!-- UPDATED FONT SIZE AND BOLDNESS: text-xl font-extrabold -->
                         <label for="roast-text" class="block text-xl font-extrabold theme-black-text mb-2">Write like youâ€™ll deny it in court later :</label>
                          <!-- Textarea: White BG, Black Text, Black Border -->
                         <textarea id="roast-text" rows="4" class="w-full p-3 border-2 border-black rounded-lg theme-white-bg theme-black-text focus:ring-black focus:border-black" placeholder=""></textarea> 
                     </div>
                     <!-- Button: "Sand roast" style -->
                     <button onclick="window.submitRoast()" class="w-full font-extrabold text-xl py-3 rounded-lg shadow-md transition duration-300 sand-roast-button">
                         Sand roast
                     </button>
                 </div>
                 
                 <!-- Login/Inbox Access Section - NOW YELLOW BACKGROUND -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black">
                    <h2 class="text-xl font-bold theme-black-text mb-4 text-center">--- OR ---</h2>
                    <h2 class="text-2xl font-bold theme-black-text mb-4 text-center">check how much fucked up you are</h2>
                     <div class="grid grid-cols-2 gap-4">
                         ${friendsList}
                     </div>
                 </div>
             `;
        };

        // Page Name: The Hit List (Inbox)
        const renderRoastInboxView = () => {
             return `
                 <!-- Roast Inbox Card: Yellow BG, Black Text, Black Border -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black">
                     <h2 class="text-3xl font-bold theme-black-text mb-4">Inbox</h2>
                     <!-- Button to fetch roasts -->
                     <button onclick="window.getRoastsForInbox()" class="w-full font-extrabold py-3 rounded-lg shadow-md transition duration-300 gay-button">
                         Click to check messages
                     </button>
                      <!-- Display Box: Black BG, White Text, Black Border -->
                     <div id="roast-guess-box" class="mt-6 p-4 text-center theme-black-bg rounded-lg border-2 border-white">
                         <p class="text-gray-500 italic theme-white-text">Click the button above to check for new messages!</p>
                     </div>
                 </div>
             `;
        };
        
        // New: Roaster Task Management Interface
        const renderRoasterTaskInterface = (container) => {
             // Main App Container: Black BG, White Border
             container.className = 'w-full max-w-4xl theme-black-bg p-4 rounded-xl border-white-thin';
             
             // Content for the Roaster's Dashboard
             let contentHTML = `
                 <!-- Task Card: Yellow BG, Black Text, Black Border -->
                 <div class="theme-yellow p-6 rounded-xl shadow-lg border-2 border-black theme-black-text">
                     <h2 class="text-3xl font-bold theme-black-text mb-4">Task Assignment Dashboard</h2>
                     <p class="mb-4">You have reveal requests pending. Assign a silly task to the user below to reveal your identity!</p>
                     
                     <div id="roaster-task-list" class="mt-4 p-4 theme-white-bg rounded-lg border-2 border-black">
                        <p class="theme-black-text">Loading tasks...</p>
                     </div>
                 </div>
             `;

             container.innerHTML = `
                 <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black relative">
                     <!-- New button: Go Back To Spawn Point (Goes to the rules screen) -->
                     <button onclick="window.goToSpawnPoint()" class="absolute top-3 left-3 theme-black-bg theme-white-text font-semibold py-1 px-3 rounded-lg transition duration-200 border-2 border-white text-sm gay-button">
                         Go Back To Spawn Point
                     </button>

                     <!-- Logo Placeholder -->
                     <img id="app-logo-roaster" 
                          src="${IMAGE_URL}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">

                     <h1 class="text-5xl font-extrabold theme-black-text">ROASTER ADMIN</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Logged in as: **${currentUserName}**</p>
                     <p class="text-xs mt-2 theme-black-text">User ID: ${currentUserId}</p>
                 </div>

                 <!-- Navigation (Back to Inbox) -->
                 <div class="mb-6 flex justify-between">
                     <!-- Back to Inbox -->
                     <button onclick="window.goToInbox()" class="font-semibold py-2 px-4 rounded-lg transition duration-200 gay-button">
                         â† Back to Inbox
                     </button>
                     <!-- Log Out -->
                      <button onclick="window.logOut()" class="font-semibold py-2 px-4 rounded-lg transition duration-200 gay-button">
                         GO BACK
                     </button>
                 </div>

                 <!-- Main Content -->
                 <div id="main-content-area">
                     ${contentHTML}
                 </div>

                 <!-- Message Container for Feedback -->
                 <div id="message-container" class="fixed bottom-0 right-0 m-6"></div>
             `;
             // Initiate fetching tasks upon rendering this view
             window.getRoasterTasks();
        };


        const renderMainInterface = (container) => {
             // Main App Container: Black BG, White Border
             container.className = 'w-full max-w-4xl theme-black-bg p-4 rounded-xl border-white-thin';
             
             let contentHTML = renderRoastInboxView();
             let headerTitle = 'THE HIT LIST';

             container.innerHTML = `
                 <!-- Header / Title Card: Yellow BG, Black Text, Black Border -->
                 <div class="text-center mb-8 p-6 theme-yellow rounded-xl shadow-2xl border-4 border-black relative">
                     <!-- New button: Go Back To Spawn Point (Goes to the rules screen) -->
                     <button onclick="window.goToSpawnPoint()" class="absolute top-3 left-3 theme-black-bg theme-white-text font-semibold py-1 px-3 rounded-lg transition duration-200 border-2 border-white text-sm gay-button">
                         Go Back To Spawn Point
                     </button>

                     <!-- Logo Placeholder -->
                     <img id="app-logo-inbox" 
                          src="${IMAGE_URL}" 
                          alt="App Logo" 
                          class="w-24 h-24 mx-auto rounded-full border-4 border-black mb-4 object-cover">
                     <!-- END Logo Placeholder: Replace the 'src' above with your ImageBB URL -->

                     <!-- The existing "Change User" button logic is now handled by logOut() and this button -->
                     <h1 class="text-5xl font-extrabold theme-black-text">${headerTitle}</h1>
                     <p class="text-lg font-semibold mt-2 theme-black-text">Logged in as: **${currentUserName}**</p>
                     <p class="text-xs mt-2 theme-black-text">User ID: ${currentUserId}</p>
                 </div>

                 <!-- Navigation (Back to Send Roast) and Roaster Admin Link -->
                 <div class="mb-6 flex justify-between">
                     <!-- GO BACK button -->
                     <button onclick="window.logOut()" class="font-semibold py-2 px-4 rounded-lg transition duration-200 gay-button">
                         GO BACK
                     </button>
                     <!-- Roaster Admin Button -->
                     <button onclick="window.goToRoasterTasks()" class="font-semibold py-2 px-4 rounded-lg transition duration-200 login-button">
                         ROASTER ADMIN
                     </button>
                 </div>

                 <!-- Main Content -->
                 <div id="main-content-area">
                     ${contentHTML}
                 </div>

                 <!-- Message Container for Feedback -->
                 <div id="message-container" class="fixed bottom-0 right-0 m-6"></div>
             `;
             // Start listening for inbox changes immediately after rendering the interface
             window.getRoastsForInbox();
        };


        // Initial setup
        window.onload = initializeFirebase;
    </script>

    <!-- Modal Root Container (for popups) -->
    <div id="modal-root"></div>
    
    <!-- Message Container for Feedback -->
    <div id="message-container" class="fixed bottom-0 right-0 m-6"></div>

    <div id="app-container" class="w-full max-w-lg theme-black-bg p-6 rounded-xl border-white-thin">
        <div class="text-center py-10 theme-white-text">
            <svg class="animate-spin h-8 w-8 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white">Loading App...</p>
        </div>
    </div>

</body>
</html>
